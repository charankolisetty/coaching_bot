{% extends "base.html" %}

{% block title %}Meeraq Coach Bot{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-md h-[80vh] flex flex-col">
    <div class="p-4 border-b bg-[#394867]">
        <h2 class="text-xl font-semibold text-white">Meeraq Coach Bot</h2>
    </div>

    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-[#F1F6F9]">
        <!-- Welcome message -->
        <div class="flex items-start space-x-2">
            <div class="bg-white rounded-lg p-3 max-w-[80%] shadow-sm">
                <p class="text-[#212A3E]">Hi! I'm your AI Coach Bot, thoughtfully crafted by the Meeraq team. You can start chatting......</p>
            </div>
        </div>

        <!-- Chat history -->
        {% for message in chat_history %}
        <div class="flex flex-col space-y-2">
            <div class="flex justify-end">
                <div class="message user-message" data-time="{{ message.timestamp|format_time }}">
                    <p class="text-white">{{ message.prompt }}</p>
                </div>
            </div>
            <div class="flex items-start space-x-2">
                <div class="message bot-message" data-time="{{ message.timestamp|format_time }}">
                    <p class="text-white">{{ message.prompt }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="border-t p-4 bg-white">
        <form id="chat-form" class="flex space-x-4">
            <textarea
                id="prompt"
                name="prompt"
                required
                class="chat-input flex-1 rounded-lg border-[#9BA4B5] focus:border-[#394867] focus:ring-[#394867]"
                placeholder="Type your message..."
                rows="1"
            ></textarea>
            <button type="submit"
                class="bg-[#394867] text-white px-6 py-2 rounded-lg hover:bg-[#212A3E] transition-colors h-[44px] flex-shrink-0 focus:outline-none focus:ring-2 focus:ring-[#394867] focus:ring-offset-2">
                <span>Send</span>
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const chatMessages = $('#chat-messages');
    const chatForm = $('#chat-form');
    const promptInput = $('#prompt');
    const submitButton = chatForm.find('button[type="submit"]');
    const originalButtonText = submitButton.html();

    // Auto-resize textarea
    promptInput.on('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        // Reset if empty
        if (this.value === '') {
            this.style.height = '44px';
        }
    });

    // Scroll to bottom with animation
    function scrollToBottom() {
        const shouldScroll = chatMessages[0].scrollHeight - chatMessages.scrollTop() - chatMessages.outerHeight() < 100;
        if (shouldScroll) {
            chatMessages.animate({ scrollTop: chatMessages[0].scrollHeight }, 'fast');
        }
    }

    // Auto scroll on new messages
    const observer = new MutationObserver(scrollToBottom);
    observer.observe(chatMessages[0], {
        childList: true,
        subtree: true
    });

    // Initial scroll
    scrollToBottom();

    chatForm.on('submit', function(e) {
        e.preventDefault();
        
        const prompt = promptInput.val().trim();
        if (!prompt) return;

        // Reset textarea height
        promptInput.css('height', '44px');

        // Disable form and update button
        chatForm.addClass('disabled');
        submitButton.html('<i class="fas fa-spinner fa-spin mr-2"></i>Processing...');
        submitButton.prop('disabled', true);
        
        // Add user message
        addMessage(prompt, 'user');
        promptInput.val('');

        // Show typing indicator
        showTypingIndicator();

        // Send request to server
        $.ajax({
            url: '/chat',
            method: 'POST',
            data: { prompt: prompt },
            success: function(response) {
                removeTypingIndicator();
                addMessage(response.response, 'bot');
            },
            error: function(xhr, status, error) {
                removeTypingIndicator();
                const errorMessage = xhr.responseJSON?.error || 'An error occurred. Please try again.';
                showErrorMessage(errorMessage);
            },
            complete: function() {
                // Reset form and button
                chatForm.removeClass('disabled');
                submitButton.html(originalButtonText);
                submitButton.prop('disabled', false);
                promptInput.focus();
                scrollToBottom();
            }
        });
    });

function addMessage(text, type) {
    const time = new Date().toLocaleString('en-US', { 
        hour: 'numeric', 
        minute: 'numeric', 
        hour12: true,
        timeZone: 'Asia/Kolkata'
    });
    
    let messageHTML;

        if (type === 'user') {
            messageHTML = `
                <div class="flex justify-end">
                    <div class="message user-message" data-time="${time}">
                        <p class="text-white">${text}</p>
                    </div>
                </div>
            `;
        } else {
            messageHTML = `
                <div class="flex items-start space-x-2">
                    <div class="message bot-message" data-time="${time}">
                        <p class="text-[#212A3E]">${text}</p>
                    </div>
                </div>
            `;
        }
        
        chatMessages.append(messageHTML);
        scrollToBottom();
    }

    function showTypingIndicator() {
        const indicator = `
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>`;
        chatMessages.append(indicator);
        scrollToBottom();
    }

    function showErrorMessage(text) {
        const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        const errorHTML = `
            <div class="message error-message" data-time="${time}">
                <p>${text}</p>
            </div>
        `;
        chatMessages.append(errorHTML);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        $('.typing-indicator').remove();
    }

    // Handle Enter key (submit on Enter, new line on Shift+Enter)
    promptInput.on('keydown', function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            chatForm.submit();
        }
    });

    // Reset form if it was stuck
    setTimeout(function() {
        submitButton.html(originalButtonText);
        submitButton.prop('disabled', false);
        chatForm.removeClass('disabled');
    }, 1000);
});
</script>
{% endblock %}