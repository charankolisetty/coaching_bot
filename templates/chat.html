{% extends "base.html" %}

{% block title %}Meeraq Coach Bot{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white rounded-lg shadow-lg h-screen flex flex-col">
    <!-- Fixed Header -->
    <div class="p-4 bg-gradient-to-r from-[#E6007E] via-[#9B3899] to-[#1B1464] border-b sticky top-0 z-50">
        <div class="flex items-center justify-between">
            <div class="w-1/3">
                <span class="text-2xl font-bold text-white" style="font-family: 'Arial', sans-serif;">
                    meeraq
                </span>
            </div>
            <div class="w-1/3 text-center">
                <span class="text-xl text-white font-semibold">Coach Bot</span>
            </div>
            <div class="w-1/3 flex justify-end space-x-3">
                <span class="text-white text-sm">
                    <i class="fas fa-user mr-1"></i>
                    {{ session.get('username') }}
                </span>
                <a href="{{ url_for('chat_history') }}" 
                   class="bg-white/10 text-white text-sm px-3 py-1 rounded-full hover:bg-white/20 transition-colors">
                    <i class="fas fa-history mr-1"></i>
                    History
                </a>
                <a href="{{ url_for('logout') }}" 
                   class="bg-white/10 text-white text-sm px-3 py-1 rounded-full hover:bg-white/20 transition-colors">
                    <i class="fas fa-sign-out-alt mr-1"></i>
                    Exit
                </a>
            </div>
        </div>
    </div>

    <!-- Messages Container -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-gray-50">
        <!-- Welcome message -->
        <div class="flex items-start">
            <div class="message bot-message">
                <p class="text-gray-800">Hi! I'm your AI Coach Bot, thoughtfully crafted by the Meeraq team. You can start chatting......</p>
            </div>
        </div>

        <!-- Messages will be added here dynamically -->
    </div>

    <!-- Fixed Input Area -->
    <div class="border-t p-4 bg-white sticky bottom-0 z-50">
        <form id="chat-form" class="flex space-x-4">
            <textarea
                id="prompt"
                name="prompt"
                required
                class="flex-1 rounded-lg border-2 border-[#E6007E] focus:border-[#9B3899] focus:ring-[#9B3899] min-h-[44px] py-2 px-4 resize-none bg-white"
                placeholder="Type your message..."
                rows="1"
            ></textarea>
            <button type="submit"
                    class="bg-gradient-to-r from-[#E6007E] to-[#9B3899] text-white px-6 py-2 rounded-lg hover:opacity-90 transition-all duration-200 h-[44px] flex-shrink-0 flex items-center justify-center min-w-[100px] shadow-md">
                Send
            </button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
$(document).ready(function() {
    const chatMessages = $('#chat-messages');
    const chatForm = $('#chat-form');
    const promptInput = $('#prompt');
    const submitButton = chatForm.find('button[type="submit"]');
    const originalButtonText = submitButton.html();

    // Auto-resize textarea
    promptInput.on('input', function() {
        this.style.height = '44px';
        this.style.height = (this.scrollHeight) + 'px';
    });

    // Scroll to bottom function
    function scrollToBottom() {
        chatMessages.scrollTop(chatMessages[0].scrollHeight);
    }

    chatForm.on('submit', function(e) {
        e.preventDefault();
        
        const prompt = promptInput.val().trim();
        if (!prompt) return;

        // Reset textarea height
        promptInput.css('height', '44px');
        promptInput.val('');

        // Disable form and update button
        chatForm.addClass('disabled');
        submitButton.html('<i class="fas fa-spinner fa-spin mr-2"></i>Processing...');
        submitButton.prop('disabled', true);
        
        // Add user message
        addUserMessage(prompt);

        // Show typing indicator
        showTypingIndicator();

        // Send request to server
        $.ajax({
            url: '/chat',
            method: 'POST',
            data: { prompt: prompt },
            success: function(response) {
                removeTypingIndicator();
                addBotMessage(response.response);
            },
            error: function(xhr, status, error) {
                removeTypingIndicator();
                const errorMessage = xhr.responseJSON?.error || 'An error occurred. Please try again.';
                addErrorMessage(errorMessage);
            },
            complete: function() {
                // Reset form and button
                chatForm.removeClass('disabled');
                submitButton.html('Send');
                submitButton.prop('disabled', false);
                promptInput.focus();
            }
        });
    });

    // Message adding functions
    function addUserMessage(text) {
        const messageHTML = `
            <div class="flex justify-end mb-6 animate-fade-in">
                <div class="message user-message">
                    <p class="text-white">${escapeHtml(text)}</p>
                </div>
            </div>
        `;
        chatMessages.append(messageHTML);
        scrollToBottom();
    }

    function addBotMessage(text) {
        const messageHTML = `
            <div class="flex items-start mb-6 animate-fade-in">
                <div class="message bot-message">
                    <p class="text-gray-800">${escapeHtml(text)}</p>
                </div>
            </div>
        `;
        chatMessages.append(messageHTML);
        scrollToBottom();
    }

    function addErrorMessage(text) {
        const messageHTML = `
            <div class="flex items-start mb-6 animate-fade-in">
                <div class="message error-message">
                    <p class="text-red-600">${escapeHtml(text)}</p>
                </div>
            </div>
        `;
        chatMessages.append(messageHTML);
        scrollToBottom();
    }

    function showTypingIndicator() {
        const indicator = `
            <div class="typing-indicator animate-fade-in">
                <span></span>
                <span></span>
                <span></span>
            </div>`;
        chatMessages.append(indicator);
        scrollToBottom();
    }

    function removeTypingIndicator() {
        $('.typing-indicator').remove();
    }

    // HTML escaping function for security
    function escapeHtml(unsafe) {
        return unsafe
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }

    // Handle Enter key
    promptInput.on('keydown', function(e) {
        if (e.which === 13 && !e.shiftKey) {
            e.preventDefault();
            chatForm.submit();
        }
    });
});
</script>
{% endblock %}