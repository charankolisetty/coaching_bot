{% extends "base.html" %}

{% block title %}Meeraq Chat{% endblock %}

{% block content %}
<div class="chat-container h-screen flex flex-col">
    <!-- Chatbox Header -->
    <div class="p-4 bg-black text-white sticky top-0 z-10 shadow-md">
        <h1 class="text-2xl font-extrabold text-center tracking-wide">COACH BOT</h1>
    </div>

    <!-- Chat messages area -->
    <div id="chat-messages" class="flex-1 overflow-y-auto p-4 space-y-4 bg-white h-[calc(100vh-160px)]">
        {% for message in chat_history %}
        <div class="flex flex-col space-y-4">
            {% if not loop.first %}
            <!-- User message -->
            <div class="flex justify-end">
                <div class="message user-message">
                    <p class="text-white">{{ message.prompt }}</p>
                </div>
            </div>
            {% endif %}
            <!-- Bot message -->
            <div class="flex items-start">
                <div class="message bot-message">
                    <p class="text-gray-800">{{ message.response }}</p>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Input area -->
    <div class="border-t p-4 bg-white sticky bottom-0 shadow-top">
        <form id="chat-form" class="flex space-x-4">
            <div class="flex-1 relative">
                <textarea id="prompt" name="prompt" required
                    class="w-full rounded-lg border-2 border-[#E6007E] focus:border-[#9B3899] focus:ring-[#9B3899] py-3 px-4 resize-none max-h-32 min-h-[44px]"
                    placeholder="Type your message..." rows="1"></textarea>
            </div>
            <button type="submit"
                class="bg-gradient-to-r from-[#E6007E] to-[#1B1464] text-white px-6 py-2 rounded-lg hover:opacity-90 transition-all duration-200 h-[44px] flex-shrink-0 flex items-center justify-center min-w-[100px]">
                <span>Send</span>
            </button>
        </form>
    </div>
</div>

<style>
    .shadow-top {
        box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1);
    }
    
    #chat-messages {
        scrollbar-width: thin;
        scrollbar-color: rgba(156, 163, 175, 0.5) transparent;
    }
    
    #chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    #chat-messages::-webkit-scrollbar-track {
        background: transparent;
    }
    
    #chat-messages::-webkit-scrollbar-thumb {
        background-color: rgba(156, 163, 175, 0.5);
        border-radius: 3px;
    }
</style>

{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function () {
        const chatMessages = $('#chat-messages');
        const chatForm = $('#chat-form');
        const promptInput = $('#prompt');
        const submitButton = chatForm.find('button[type="submit"]');
        const originalButtonText = submitButton.html();

        // Auto-resize textarea
        promptInput.on('input', function () {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 200) + 'px'; // Max height of 200px
            if (this.value === '') {
                this.style.height = '44px';
            }
        });

        // Scroll to bottom function
        function scrollToBottom(animate = true) {
            const scrollHeight = chatMessages[0].scrollHeight;
            if (animate) {
                chatMessages.animate({ scrollTop: scrollHeight }, {
                    duration: 300,
                    easing: 'swing',
                    complete: () => {
                        // Double-check scroll position after animation
                        if (chatMessages.scrollTop() + chatMessages.innerHeight() < scrollHeight) {
                            chatMessages.scrollTop(scrollHeight);
                        }
                    }
                });
            } else {
                chatMessages.scrollTop(scrollHeight);
            }
        }

        // Initial scroll
        scrollToBottom(false);

        chatForm.on('submit', function (e) {
            e.preventDefault();

            const prompt = promptInput.val().trim();
            if (!prompt) return;

            promptInput.css('height', '44px');

            chatForm.addClass('disabled');
            submitButton.html('<i class="fas fa-spinner fa-spin mr-2"></i>Processing...');
            submitButton.prop('disabled', true);

            addMessage(prompt, 'user');
            promptInput.val('');

            showTypingIndicator();

            $.ajax({
                url: '/chat',
                method: 'POST',
                data: { prompt: prompt },
                success: function (response) {
                    removeTypingIndicator();
                    addMessage(response.response, 'bot');
                },
                error: function (xhr) {
                    removeTypingIndicator();
                    const errorMessage = xhr.responseJSON?.error || 'An error occurred. Please try again.';
                    showErrorMessage(errorMessage);
                },
                complete: function () {
                    chatForm.removeClass('disabled');
                    submitButton.html(originalButtonText);
                    submitButton.prop('disabled', false);
                    promptInput.focus();
                    scrollToBottom();
                }
            });
        });

        function addMessage(text, type) {
            const messageHTML = type === 'user'
                ? `<div class="flex justify-end">
                    <div class="message user-message">
                        <p class="text-white">${text}</p>
                    </div>
                   </div>`
                : `<div class="flex items-start">
                    <div class="message bot-message">
                        <p class="text-gray-800">${text}</p>
                    </div>
                   </div>`;
            chatMessages.append(messageHTML);
            scrollToBottom();
        }

        function showTypingIndicator() {
            const indicator = `
            <div class="typing-indicator">
                <span></span>
                <span></span>
                <span></span>
            </div>`;
            chatMessages.append(indicator);
            scrollToBottom();
        }

        function showErrorMessage(text) {
            const errorHTML = `
            <div class="message error-message">
                <p>${text}</p>
            </div>`;
            chatMessages.append(errorHTML);
            scrollToBottom();
        }

        function removeTypingIndicator() {
            $('.typing-indicator').remove();
        }

        promptInput.on('keydown', function (e) {
            if (e.which === 13 && !e.shiftKey) {
                e.preventDefault();
                chatForm.submit();
            }
        });

        // Handle scrolling
        let lastScrollTop = 0;
        chatMessages.on('scroll', function() {
            const st = $(this).scrollTop();
            // Only auto-scroll if we're near the bottom and scrolling down
            if (st > lastScrollTop) {
                const scrollHeight = $(this)[0].scrollHeight;
                const scrollPosition = st + $(this).height();
                if (scrollHeight - scrollPosition < 100) {
                    scrollToBottom(true);
                }
            }
            lastScrollTop = st;
        });
    });
</script>
{% endblock %}